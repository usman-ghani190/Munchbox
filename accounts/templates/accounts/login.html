{% extends 'base.html' %}
  {% load static %}
  {% block title %}Munchbox | Login{% endblock %}
  {% block content %}
  <div class="inner-wrapper">
    <div class="container-fluid no-padding">
      <div class="row no-gutters overflow-auto">
        <div class="col-md-6">
          <div class="main-banner">
            <img src="{% static 'app/assets/img/banner/banner-1.jpg' %}" class="img-fluid full-width main-img" alt="banner" />
            <div class="overlay-2 main-padding">
              <img src="{% static 'app/assets/img/logo-2.jpg' %}" class="img-fluid" alt="logo" />
            </div>
            <img src="{% static 'app/assets/img/banner/burger.png' %}" class="footer-img" alt="footer-img" />
          </div>
        </div>
        <div class="col-md-6">
          <div class="section-2 user-page main-padding">
            <div class="login-sec">
              <div class="login-box">
                <!-- Sign-out button (visible if authenticated) -->
                {% if user.is_authenticated %}
                <div class="form-group text-right">
                  <button id="logout-btn" class="btn-second btn-submit">Sign out</button>
                </div>
                {% endif %}
                <form id="login-form">
                  <h4 class="text-light-black fw-600">
                    Sign in with your Munchbox account
                  </h4>
                  <div id="form-errors" class="alert alert-danger" style="display: none;"></div>
                  <div class="row">
                    <div class="col-12">
                      <p class="text-light-black">
                        Have a corporate username?
                        <a href="{% url 'add_restaurant' %}">Click here</a>
                      </p>
                      <div class="form-group">
                        <label class="text-light-white fs-14">Email</label>
                        <input
                          type="email"
                          name="email"
                          class="form-control form-control-submit"
                          placeholder="Email I'd"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label class="text-light-white fs-14">Password</label>
                        <input
                          type="password"
                          id="password-field"
                          name="password"
                          class="form-control form-control-submit"
                          placeholder="Password"
                          required
                        />
                        <div
                          data-name="#password-field"
                          class="fa fa-fw fa-eye field-icon toggle-password"
                        ></div>
                      </div>
                      <div class="form-group checkbox-reset">
                        <label class="custom-checkbox mb-0">
                          <input type="checkbox" name="keep_signed_in" />
                          <span class="checkmark"></span> Keep me signed in
                        </label>
                        <a href="{% url 'password_reset' %}">Reset password</a>
                      </div>
                      <div class="form-group">
                        <button
                          type="submit"
                          class="btn-second btn-submit full-width"
                        >
                          <img
                            src="{% static 'app/assets/img/M.png' %}"
                            alt="btn logo"
                          />Sign in
                        </button>
                      </div>
                      <div class="form-group text-center">
                        <span>or</span>
                      </div>
                      <div class="form-group">
                        <button
                          type="submit"
                          class="btn-second btn-facebook full-width"
                        >
                          <img
                            src="{% static 'app/assets/img/facebook-logo.svg' %}"
                            alt="btn logo"
                          />Continue with Facebook
                        </button>
                      </div>
                      <div class="form-group">
                        <button
                          type="submit"
                          class="btn-second btn-google full-width"
                        >
                          <img
                            src="{% static 'app/assets/img/google-logo.png' %}"
                            alt="btn logo"
                          />Continue with Google
                        </button>
                      </div>
                      <div class="form-group text-center mb-0">
                        <a href="{% url 'register' %}">Create your account</a>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endblock %}
  {% block extra_scripts %}
  <script src="{% static 'app/assets/js/jquery.min.js' %}"></script>
  <script src="{% static 'app/assets/js/popper.min.js' %}"></script>
  <script src="{% static 'app/assets/js/bootstrap.min.js' %}"></script>
  <script src="{% static 'app/assets/js/ion.rangeSlider.min.js' %}"></script>
  <script src="{% static 'app/assets/js/swiper.min.js' %}"></script>
  <script src="{% static 'app/assets/js/jquery.nice-select.min.js' %}"></script>
  <script src="{% static 'app/assets/js/jquery.magnific-popup.min.js' %}"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnd9JwZvXty-1gHZihMoFhJtCXmHfeRQg"></script>
  <script src="{% static 'app/assets/js/sticksy.js' %}"></script>
  <script src="{% static 'app/assets/js/munchbox.js' %}"></script>
  <script>
    $(document).ready(function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // Login form submission
        $('#login-form').on('submit', function(e) {
            e.preventDefault();
            var formData = $(this).serializeArray();
            var data = {};
            $.each(formData, function(i, field) {
                data[field.name] = field.value;
            });
            console.log('Submitting login form...');
            $.ajax({
                url: '{% url 'api_login' %}',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
                headers: {'X-CSRFToken': csrftoken},
                success: function(response) {
                    console.log('Login successful:', response);
                    localStorage.setItem('token', response.token);
                    window.location.href = '/';
                },
                error: function(xhr) {
                    console.error('Login failed:', xhr.responseJSON);
                    var errors = xhr.responseJSON;
                    var errorHtml = '';
                    $.each(errors, function(key, value) {
                        errorHtml += '<p>' + (Array.isArray(value) ? value.join('<br>') : value) + '</p>';
                    });
                    $('#form-errors').html(errorHtml).show();
                }
            });
        });

        // Logout button
        $('#logout-btn').on('click', function(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            console.log('Sending logout with token:', token);
            if (!token) {
                console.log('No token found, redirecting to login');
                window.location.href = '{% url 'login' %}';
                return;
            }
            $.ajax({
                url: '{% url 'api_logout' %}',
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Authorization': 'Token ' + token
                },
                success: function(response) {
                    console.log('Logout successful:', response);
                    localStorage.removeItem('token');
                    window.location.href = '{% url 'login' %}';
                },
                error: function(xhr) {
                    console.error('Logout failed:', xhr.responseJSON);
                    $('#form-errors').html('<p>Logout failed: ' + (xhr.responseJSON.detail || 'Unauthorized') + '</p>').show();
                    localStorage.removeItem('token');
                    window.location.href = '{% url 'login' %}';
                }
            });
        });

        // Password toggle
        $('.toggle-password').on('click', function() { // Added .on() for event binding
            console.log('Toggling password visibility'); // Debug log
            var field = $($(this).data('name'));
            if (field.length) { // Check if field exists
                var type = field.attr('type') === 'password' ? 'text' : 'password';
                field.attr('type', type);
                $(this).toggleClass('fa-eye fa-eye-slash');
            } else {
                console.error('Password field not found for:', $(this).data('name'));
            }
        });
    });
  </script>
  {% endblock %}