{% extends 'base.html' %}
{% load static %}

{% block title %}
Munchbox | Home
{% endblock title %}

{% block content %}
<div class="main-sec"></div>
<!-- Navigation -->
<div class="inner-wrapper">
  <div class="container-fluid no-padding">
    <div class="row no-gutters">
      <div class="col-md-6">
        <div class="main-banner">
          <img
            src="{% static 'app/assets/img/banner/banner-2.jpg' %}"
            class="img-fluid full-width main-img"
            alt="banner"
          />
          <div class="overlay

-2 main-padding">
            <img
              src="{% static 'app/assets/img/logo-2.jpg' %}"
              class="img-fluid"
              alt="logo"
            />
          </div>
          <img
            src="{% static 'app/assets/img/banner/burger.png' %}"
            class="footer-img"
            alt="footer-img"
          />
        </div>
      </div>
      <div class="col-md-6">
        <div class="section-2 main-page main-padding">
          <div class="top-nav">
            <h5>
              <a href="{% url 'home:explore' %}" class="text-light-green fw-700">Explore</a>
            </h5>
            <h5>
              {% if user.is_authenticated %}
                <button id="logout-btn" class="text-light-green fw-700" style="background:none;border:none;padding:0;cursor:pointer;">Sign out</button>
              {% else %}
                <a href="{% url 'accounts:login' %}" class="text-light-green fw-700">Sign in</a>
              {% endif %}
            </h5>
          </div>
          <div class="login-box">
            <div class="col-12">
              <h1 class="text-light-black fw-700">
                Munchbox food delivery every time
              </h1>
              <div class="input-group row">
                <div class="input-group2 col-xl-8">
                  <input
                    type="search"
                    class="form-control form-control-submit"
                    placeholder="Enter street address or zip code"
                    value="1246 57th St, Brooklyn, NY, 11219"
                  />
                  <div class="input-group-prepend">
                    <button class="input-group-text text-light-green">
                      <i class="fab fa-telegram-plane"></i>
                    </button>
                  </div>
                </div>
                <div class="input-group-append col-xl-4">
                  <button
                    class="btn-second btn-submit full-width"
                    type="button"
                  >
                    Find food
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Browse by category -->
<section class="browse-cat u-line section-padding">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="section-header-left">
          <h3 class="text-light-black header-title title">
            Browse by cuisine
            <span class="fs-14">
              {% if restaurant and restaurant.id and restaurant.id|length == 36 %}
                <a href="{% url 'restaurants:restaurant' restaurant_id=restaurant.id %}">See all restaurant</a>
              {% else %}
                <a href="{% url 'restaurants:list_restaurants' %}">See all restaurants</a>
              {% endif %}
            </span>
          </h3>
        </div>
      </div>
      <div class="col-12">
        <div class="category-slider swiper-container">
          <div class="swiper-wrapper">
            <div class="swiper-slide">
              <a href="{% url 'restaurants:restaurants_by_category' category='Brooklyn' %}" class="categories">
                <div class="icon icon-parent text-custom-white bg-light-green">
                  <i class="fas fa-map-marker-alt"></i>
                </div>
                <span class="text-light-black cat-name">Brooklyn</span>
              </a>
            </div>
            <div class="swiper-slide">
              <a href="{% url 'restaurants:restaurants_by_category' category='Italian' %}" class="categories">
                <div class="icon text-custom-white bg-light-green">
                  <img src="{% static 'app/assets/img/svg/004-leaf.svg' %}" alt="icon" />
                </div>
                <span class="text-light-black cat-name">Italian</span>
              </a>
            </div>
            <div class="swiper-slide">
              <a href="{% url 'restaurants:restaurants_by_category' category='Thai' %}" class="categories">
                <div class="icon text-custom-white bg-light-green">
                  <img src="{% static 'app/assets/img/restaurants/125x125/cuisine-2.jpg' %}" class="rounded-circle" alt="categories" />
                </div>
                <span class="text-light-black cat-name">Thai</span>
              </a>
            </div>
            <div class="swiper-slide">
              <a href="{% url 'restaurants:restaurants_by_category' category='Chinese' %}" class="categories">
                <div class="icon text-custom-white bg-light-green">
                  <img src="{% static 'app/assets/img/restaurants/125x125/cuisine-3.jpg' %}" class="rounded-circle" alt="categories" />
                </div>
                <span class="text-light-black cat-name">Chinese</span>
              </a>
            </div>
            <div class="swiper-slide">
              {% if restaurant and restaurant.id and restaurant.id|length == 36 %}
                <a href="{% url 'restaurants:restaurant' restaurant_id=restaurant.id %}" class="categories">
              {% else %}
                <a href="{% url 'restaurants:list_restaurants' %}" class="categories">
              {% endif %}
                <div class="icon text-custom-white bg-light-green">
                  <img src="{% static 'app/assets/img/restaurants/125x125/cuisine-4.jpg' %}" class="rounded-circle" alt="categories" />
                </div>
                <span class="text-light-black cat-name">Mexican</span>
              </a>
            </div>
            <div class="swiper-slide">
              {% if restaurant and restaurant.id and restaurant.id|length == 36 %}
                <a href="{% url 'restaurants:restaurant' restaurant_id=restaurant.id %}" class="categories">
              {% else %}
                <a href="{% url 'restaurants:list_restaurants' %}" class="categories">
              {% endif %}
                <div class="icon text-custom-white bg-light-green">
                  <img src="{% static 'app/assets/img/restaurants/125x125/cuisine-5.jpg' %}" class="rounded-circle" alt="categories" />
                </div>
                <span class="text-light-black cat-name">Indian</span>
              </a>
            </div>
            <div class="swiper-slide">
              {% if restaurant and restaurant.id and restaurant.id|length == 36 %}
                <a href="{% url 'restaurants:restaurant' restaurant_id=restaurant.id %}" class="categories">
              {% else %}
                <a href="{% url 'restaurants:list_restaurants' %}" class="categories">
              {% endif %}
                <div class="icon text-custom-white bg-light-green">
                  <img src="{% static 'app/assets/img/restaurants/125x125/cuisine-6.jpg' %}" class="rounded-circle" alt="categories" />
                </div>
                <span class="text-light-black cat-name">Lebanese</span>
              </a>
            </div>
            <div class="swiper-slide">
              {% if restaurant and restaurant.id and restaurant.id|length == 36 %}
                <a href="{% url 'restaurants:restaurant' restaurant_id=restaurant.id %}" class="categories">
              {% else %}
                <a href="{% url 'restaurants:list_restaurants' %}" class="categories">
              {% endif %}
                <div class="icon text-custom-white bg-light-green">
                  <img src="{% static 'app/assets/img/restaurants/125x125/cuisine-7.jpg' %}" class="rounded-circle" alt="categories" />
                </div>
                <span class="text-light-black cat-name">Japanese</span>
              </a>
            </div>
            <div class="swiper-slide">
              {% if restaurant and restaurant.id and restaurant.id|length == 36 %}
                <a href="{% url 'restaurants:restaurant' restaurant_id=restaurant.id %}" class="categories">
              {% else %}
                <a href="{% url 'restaurants:list_restaurants' %}" class="categories">
              {% endif %}
                <div class="icon text-custom-white bg-light-green">
                  <img src="{% static 'app/assets/img/restaurants/125x125/cuisine-8.jpg' %}" class="rounded-circle" alt="categories" />
                </div>
                <span class="text-light-black cat-name">American</span>
              </a>
            </div>
          </div>
          <!-- Add Arrows -->
          <div class="swiper-button-next"></div>
          <div class="swiper-button-prev"></div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Browse by category -->
<!-- your previous order -->
<section class="recent-order section-padding">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="section-header-left">
          <h3 class="text-light-black header-title title">
            Your previous orders
            <span class="fs-14">
              <a href="{% url 'restaurants:order_history' %}">See all past orders</a>
            </span>
          </h3>
        </div>
      </div>
      {% if recent_orders %}
        {% for order in recent_orders %}
          <div class="col-lg-3 col-md-6 col-sm-6">
            <div class="product-box mb-md-20">
              <div class="product-img">
                <a href="{% url 'restaurants:restaurant' restaurant_id=order.restaurant.id %}">
                  {% with order_item=order.order_items.first %}
                    {% if order_item.menu_item.image %}
                      <img src="{{ order_item.menu_item.image.url }}" class="img-fluid full-width" alt="product-img" />
                    {% else %}
                      {% with img_number=forloop.counter|stringformat:"s" %}
                        <img src="{% static 'app/assets/img/restaurants/255x104/order-'|add:img_number|add:'.jpg' %}" class="img-fluid full-width" alt="product-img" />
                      {% endwith %}
                    {% endif %}
                  {% endwith %}
                </a>
              </div>
              <div class="product-caption">
                <h6 class="product-title">
                  <a href="{% url 'restaurants:restaurant' restaurant_id=order.restaurant.id %}" class="text-light-black">
                    {% with order_item=order.order_items.first %}
                      {{ order_item.menu_item.name }}
                    {% endwith %}
                  </a>
                </h6>
                <p class="text-light-white">{{ order.restaurant.name }}, {{ order.restaurant.city }}</p>
                <div class="product-btn">
                  <a href="{% url 'restaurants:order_details' order_id=order.id %}" class="btn-first white-btn full-width text-light-green fw-600">
                    Track Order
                  </a>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="col-12">
          <p class="text-light-black">You have no recent orders.</p>
        </div>
      {% endif %}
    </div>
  </div>
</section>
<!-- your previous order -->
<!-- Explore collection -->
<section class="ex-collection section-padding">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="section-header-left">
          <h3 class="text-light-black header-title title">
            Explore our collections
          </h3>
        </div>
      </div>
    </div>
    <div class="row">
      {% for collection in collections %}
        <div class="col-md-6">
          <div class="ex-collection-box mb-xl-20">
            <img
              src="{% if collection.image %}{{ collection.image.url }}{% else %}{% static 'app/assets/img/restaurants/540x300/collection-1.jpg' %}{% endif %}"
              class="img-fluid full-width"
              alt="image"
            />
            <div class="category-type overlay padding-15">
              {% if collection.filter_type == 'top_rated' %}
                <a href="{% url 'restaurants:top_rated_restaurants' %}" class="category-btn">{{ collection.name }}</a>
              {% elif collection.filter_type == 'popular_near_you' %}
                <a href="{% url 'restaurants:popular_near_you' %}" class="category-btn">{{ collection.name }}</a>
              {% else %}
                <a href="{% url 'restaurants:list_restaurants' %}" class="category-btn">{{ collection.name }}</a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="row">
      <div class="col-lg-3 col-md-4">
        <div class="large-product-box mb-xl-20 p-relative">
          <img
            src="{% static 'app/assets/img/restaurants/255x587/Banner-10.jpg' %}"
            class="img-fluid full-width"
            alt="image"
          />
          <div class="category-type overlay padding-15">
            <button class="category-btn">Most popular near you</button>
            <a
              href="{% url 'restaurants:popular_near_you' %}"
              class="btn-first white-btn text-light-black fw-600 full-width"
            >See all</a>
          </div>
        </div>
      </div>
      <div class="col-lg-9 col-md-8">
        <div class="row">
          {% for restaurant in curated_restaurants %}
            <div class="col-lg-4 col-md-6 col-sm-6">
              <div class="product-box mb-xl-20">
                <div class="product-img">
                  <a href="{% url 'restaurants:restaurant' restaurant_id=restaurant.id %}">
                    <img
                      src="{% if restaurant.logo %}{{ restaurant.logo.url }}{% else %}{% static 'app/assets/img/restaurants/255x150/shop-1.jpg' %}{% endif %}"
                      class="img-fluid full-width"
                      alt="product-img"
                    />
                  </a>
                  <div class="overlay">
                    <div class="product-tags padding-10">
                      <span class="circle-tag">
                        <img
                          src="{% static 'app/assets/img/svg/013-heart-1.svg' %}"
                          alt="tag"
                        />
                      </span>
                      {% with menu_item=restaurant.menu_items.first %}
                        {% if menu_item and menu_item.tags.exists %}
                          {% with tag=menu_item.tags.first %}
                            <span class="type-tag {% if restaurant.average_rating >= 4.0 %}bg-gradient-green{% elif restaurant.average_rating < 3.0 %}bg-gradient-red{% else %}bg-gradient-yellow{% endif %} text-custom-white">
                              {{ tag.name }}
                            </span>
                          {% endwith %}
                        {% elif restaurant.average_rating >= 4.0 %}
                          <span class="type-tag bg-gradient-green text-custom-white">
                            Trending
                          </span>
                        {% elif restaurant.average_rating < 3.0 %}
                          <div class="custom-tag">
                            <span class="text-custom-white rectangle-tag bg-gradient-red">
                              {{ restaurant.average_rating|floatformat:1 }}
                            </span>
                          </div>
                        {% endif %}
                      {% endwith %}
                    </div>
                  </div>
                </div>
                <div class="product-caption">
                  <div class="title-box">
                    <h6 class="product-title">
                      <a href="{% url 'restaurants:restaurant' restaurant_id=restaurant.id %}" class="text-light-black">
                        {{ restaurant.name }}
                      </a>
                    </h6>
                    <div class="tags">
                      <span class="text-custom-white rectangle-tag {% if restaurant.average_rating >= 4.0 %}bg-green{% elif restaurant.average_rating < 3.0 %}bg-red{% else %}bg-yellow{% endif %}">
                        {{ restaurant.average_rating|default:0|floatformat:1 }}
                      </span>
                    </div>
                  </div>
                  <p class="text-light-white">{{ restaurant.cuisines.all|join:", " }}</p>
                  <div class="product-details">
                    <div class="price-time">
                      <span class="text-light-black time">{{ restaurant.delivery_type }}</span>
                      <span class="text-light-white price">${{ restaurant.minimum_order|default:10.00 }}</span>
                    </div>
                    <div class="rating">
                      <span>
                        {% with rating=restaurant.average_rating|default:0 %}
                          {% for i in "12345"|make_list %}
                            <i class="fas fa-star {% if rating >= i|add:'0'|floatformat:'0' %}text-yellow{% else %}text-gray{% endif %}"></i>
                          {% endfor %}
                        {% endwith %}
                      </span>
                      <span class="text-light-white text-right">
                        {{ restaurant.reviews.count }} ratings
                      </span>
                    </div>
                  </div>
                  <div class="product-footer">
                    {% with menu_item=restaurant.menu_items.first %}
                      {% if menu_item and menu_item.tags.exists %}
                        {% for tag in menu_item.tags.all %}
                          <span class="text-custom-white square-tag">
                            <img
                              src="{% if tag.icon %}{{ tag.icon.url }}{% else %}{% static 'app/assets/img/svg/004-leaf.svg' %}{% endif %}"
                              alt="tag"
                            />
                          </span>
                        {% endfor %}
                      {% else %}
                        <span class="text-custom-white square-tag">
                          <img
                            src="{% static 'app/assets/img/svg/004-leaf.svg' %}"
                            alt="tag"
                          />
                        </span>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              </div>
            </div>
          {% empty %}
            <div class="col-12">
              <p class="text-light-black">No restaurants available.</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Explore collection -->

<!-- Error Display Area -->
<div id="form-errors" class="alert" style="display:none;"></div>

{% endblock content %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Logout button
$('#logout-btn').on('click', function(e) {
    e.preventDefault();
    console.log('Logout button clicked');

    const token = localStorage.getItem('token');
    console.log('Token:', token);

    if (!token) {
        console.log('No token found');
        $('#form-errors').html('<p>No authentication token found. Redirecting to login...</p>').show();
        setTimeout(function() {
            window.location.href = '{% url "accounts:login" %}';
        }, 2000);
        return;
    }

    if (!csrftoken) {
        console.log('CSRF token not found');
        $('#form-errors').html('<p>CSRF token missing. Please refresh the page and try again.</p>').show();
        return;
    }

    $.ajax({
        url: '{% url "accounts:api_logout" %}',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Authorization': 'Token ' + token
        },
        success: function(response) {
            console.log('Logout successful:', response);
            localStorage.removeItem('token');
            $('#form-errors').html('<p>' + (response.message || 'Logged out successfully') + '</p>')
                .removeClass('alert-danger')
                .addClass('alert-success')
                .show();
            setTimeout(function() {
                window.location.reload(); // Refresh the page to show login form
            }, 2000);
        },
        error: function(xhr, status, error) {
            console.error('Logout failed:', {
                status: xhr.status,
                response: xhr.responseJSON,
                error: error
            });
            localStorage.removeItem('token');
            var errorMsg = xhr.responseJSON?.error || xhr.responseJSON?.detail || 'An error occurred during logout';
            $('#form-errors').html('<p>Logout failed: ' + errorMsg + '</p>').show();
            setTimeout(function() {
                window.location.reload(); // Refresh the page to reflect logout state
            }, 2000);
        }
    });
});
</script>
{% endblock extra_scripts %}

